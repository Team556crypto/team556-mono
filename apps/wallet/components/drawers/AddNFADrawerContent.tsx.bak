import React, { useState, useEffect, useRef } from 'react';
import { 
  Image, 
  ScrollView, 
  StyleSheet, 
  TouchableOpacity, 
  View, 
  Platform, 
  TextInput, 
  Modal, 
  Animated, 
  Dimensions, 
  Alert,
  KeyboardTypeOptions
} from 'react-native';
import { useNFAStore } from '@/store/nfaStore';
import { useDrawerStore } from '@/store/drawerStore';
import { Button, Text, Select, useTheme } from '@team556/ui';
import * as ImagePicker from 'expo-image-picker';
import * as FileSystem from 'expo-file-system';
import * as ImageManipulator from 'expo-image-manipulator';
import { useAuthStore } from '@/store/authStore';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import DateTimePicker, { DateTimePickerEvent } from '@react-native-community/datetimepicker';
import { CreateNFAPayload, nfaTypeOptions, taxStampTypeOptions } from '@/services/api';

// Screen dimensions for calculating progress bar
const { width: SCREEN_WIDTH } = Dimensions.get('window');
const TOTAL_HORIZONTAL_PADDING_FOR_PROGRESS_BAR = 32; // 16px padding on each side
const PROGRESS_BAR_RENDER_WIDTH = SCREEN_WIDTH - TOTAL_HORIZONTAL_PADDING_FOR_PROGRESS_BAR;

// Define the form state type with string values for the form that will be converted to numbers for the API payload
type NFAFormState = {
  serial: string;
  manufacturer: string;
  model: string;
  caliber: string;
  nfaType: string;
  additionalInfo: string;
  tax_stamp_submission_date: string;
  tax_stamp_approval_date: string;
  taxStampType: string;
  taxStampNumber: string;
  value: string;
  round_count: string;
  images: string[];
};

const initialState: NFAFormState = {
  serial: '',
  manufacturer: '',
  model: '',
  caliber: '',
  nfaType: '',
  additionalInfo: '',
  tax_stamp_submission_date: '',
  tax_stamp_approval_date: '',
  taxStampType: '',
  taxStampNumber: '',
  value: '0',
  round_count: '0',
  images: [],
};

const AddNFADrawerContent = () => {
  const { colors } = useTheme();
  const { addNFAItem, isLoading, error: storeError } = useNFAStore();
  const { token } = useAuthStore();
  const { closeDrawer } = useDrawerStore();

  const [formState, setFormState] = useState<NFAFormState>(initialState);
  const [currentStep, setCurrentStep] = useState(1);
  const [fieldErrors, setFieldErrors] = useState<Partial<Record<keyof NFAFormState, string>>>({});

  const [imagePickerVisible, setImagePickerVisible] = useState(false);
  const [imageUploading, setImageUploading] = useState(false);
  const [imageError, setImageError] = useState<string | null>(null);

  // Step progress animation
  const steps = ['NFA Details', 'Tax Stamp Info', 'Additional Info'];
  const progressAnim = useRef(new Animated.Value(0)).current;

  // Date picker state
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [datePickerField, setDatePickerField] = useState<keyof NFAFormState | null>(null);
  const [currentDateValue, setCurrentDateValue] = useState<Date>(new Date());

  // State for image
  const [selectedImageUri, setSelectedImageUri] = useState<string | null>(null);
  
  // Animate progress bar when step changes
  useEffect(() => {
    Animated.timing(progressAnim, {
      toValue: currentStep - 1,
      duration: 300,
      useNativeDriver: false,
    }).start();
  }, [currentStep, progressAnim]);

  // Handle input changes
  const handleInputChange = (field: keyof NFAFormState, value: string | number | boolean | null) => {
    setFormState((prev) => ({
      ...prev,
      [field]: value,
    }));

    // Clear any error for this field when it's edited
    if (fieldErrors[field]) {
      setFieldErrors((prev) => ({
        ...prev,
        [field]: undefined,
      }));
    }
  };

  // DatePicker modal date functions
  const showMode = (fieldKey: keyof NFAFormState) => {
    const fieldValue = formState[fieldKey] as string;
    const initialPickerDate =
      typeof fieldValue === 'string' && fieldValue && !isNaN(new Date(fieldValue).getTime())
        ? new Date(fieldValue)
        : new Date();

    setCurrentDateValue(initialPickerDate);
    setDatePickerField(fieldKey);
    setShowDatePicker(true);
  };

  const onDateChange = (event: DateTimePickerEvent, selectedDate?: Date) => {
    // Only update the temp state value, don't update form until confirmed
    if (selectedDate) {
      setCurrentDateValue(selectedDate);
    }
  };

  const handleConfirmDate = () => {
    if (datePickerField && currentDateValue) {
      // Update form state with ISO string when confirming
      handleInputChange(datePickerField, currentDateValue.toISOString());
    }
    setShowDatePicker(false); // Close the modal
  };
  
  const handleCancelDate = () => {
    setShowDatePicker(false); // Just close the modal without updating form
  };

  const getDateForPicker = (value: string | Date | undefined): Date | null => {
    if (!value) return null;
    if (value instanceof Date) return value;
    try {
      const date = new Date(value);
      return !isNaN(date.getTime()) ? date : null;
    } catch (e) {
      return null;
    }
  };

  // Function to render form detail rows with consistent styling
  const renderDetailRow = (
    label: string,
    field: keyof NFAFormState,
    placeholder: string,
    inputType: 'text' | 'date' | 'select' = 'text',
    items?: Array<{ label: string; value: string | number }>,
    keyboardType: KeyboardTypeOptions = 'default',
  ) => {
    const fieldValue = formState[field];
    const fieldError = fieldErrors[field];
    let inputComponent = null;

    if (inputType === 'date') {
      // Date picker implementation
      const displayDate = fieldValue
        ? new Date(fieldValue as string).toLocaleDateString()
        : '';
      
      inputComponent = (
        <TouchableOpacity 
          style={styles.dateContainer}
          onPress={() => showMode(field)}
        >
          <Text 
            style={[styles.dateText, !displayDate && styles.placeholderText]}
            numberOfLines={1}
            ellipsizeMode="tail"
          >
            {displayDate || placeholder}
          </Text>
          <MaterialCommunityIcons 
            name="calendar" 
            size={24} 
            color={Colors.primary} 
            style={styles.calendarIcon}
          />
        </TouchableOpacity>
      );
    } else if (inputType === 'select' && items) {
      // Dropdown select implementation
      const selectedItem = items.find(item => item.value === fieldValue);
      inputComponent = (
        <View style={styles.inputContainer}>
          <Select
            items={items}
            value={fieldValue as string | number}
            placeholder={placeholder}
            onValueChange={(value) => handleInputChange(field, value)}
            style={styles.selectInput}
          />
        </View>
      );
    } else {
      // Text input implementation
      inputComponent = (
        <View style={styles.inputContainer}>
          <TextInput
            style={styles.input}
            placeholder={placeholder}
            placeholderTextColor={Colors.placeholder}
            value={fieldValue as string}
            onChangeText={(text) => handleInputChange(field, text)}
            keyboardType={keyboardType}
          />
        </View>
      );
    }

    return (
      <View style={styles.detailRowContainer}>
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>{label}</Text>
          <View style={styles.rightContent}>
            {inputComponent}
          </View>
        </View>
        {fieldError && (
          <Text style={styles.errorText}>{fieldError}</Text>
        )}
      </View>
    );
  };

  // Function to handle image picking
  const pickImageAsync = async () => {
    try {
      setImageError(null);
      setImageUploading(true);

      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        quality: 1,
        aspect: [4, 3],
      });

      if (!result.canceled && result.assets && result.assets.length > 0) {
        const selectedAsset = result.assets[0];
        const uri = selectedAsset.uri;

        // Compress image before setting it
        const compressed = await ImageManipulator.manipulateAsync(
          uri,
          [{ resize: { width: 800 } }],
          { compress: 0.7, format: ImageManipulator.SaveFormat.JPEG }
        );

        // Add the image URI to the form state's images array
        setFormState(prev => ({
          ...prev,
          images: [...prev.images, compressed.uri]
        }));

        // Set selected image for preview
        setSelectedImageUri(compressed.uri);
      }
    } catch (error) {
      console.error('Error picking image:', error);
      setImageError('Failed to select image. Please try again.');
    } finally {
      setImageUploading(false);
    }
  };

  // Validate form fields for the current step
  const validateCurrentStep = () => {
    const errors: Partial<Record<keyof NFAFormState, string>> = {};

    // First step validation
    if (currentStep === 1) {
      if (!formState.serial) errors.serial = 'Serial number is required';
      if (!formState.manufacturer) errors.manufacturer = 'Manufacturer is required';
      if (!formState.model) errors.model = 'Model is required';
      if (!formState.caliber) errors.caliber = 'Caliber is required';
      if (!formState.nfaType) errors.nfaType = 'NFA type is required';
    }
    
    // Second step validation
    if (currentStep === 2) {
      if (!formState.tax_stamp_submission_date) errors.tax_stamp_submission_date = 'Submission date is required';
      if (!formState.tax_stamp_approval_date) errors.tax_stamp_approval_date = 'Approval date is required';
      if (!formState.taxStampType) errors.taxStampType = 'Tax stamp type is required';
      if (!formState.taxStampNumber) errors.taxStampNumber = 'Tax stamp number is required';
    }

    // Third step validation
    if (currentStep === 3) {
      if (!formState.value) errors.value = 'Value is required';
      if (!formState.round_count) errors.round_count = 'Round count is required';
    }

    setFieldErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // Handle next step
  const handleNextStep = () => {
    if (validateCurrentStep()) {
      if (currentStep < steps.length) {
        setCurrentStep(currentStep + 1);
      } else {
        // Submit form if on last step
        handleSubmit();
      }
    }
  };

  // Handle previous step
  const handlePrevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  // Handle form submission
  const handleSubmit = async () => {
    // Final validation of all fields
    const allErrors: Partial<Record<keyof NFAFormState, string>> = {};
    
    // Validate all fields
    if (!formState.serial) allErrors.serial = 'Serial number is required';
    if (!formState.manufacturer) allErrors.manufacturer = 'Manufacturer is required';
    if (!formState.model) allErrors.model = 'Model is required';
    if (!formState.caliber) allErrors.caliber = 'Caliber is required';
    if (!formState.nfaType) allErrors.nfaType = 'NFA type is required';
    if (!formState.tax_stamp_submission_date) allErrors.tax_stamp_submission_date = 'Submission date is required';
    if (!formState.tax_stamp_approval_date) allErrors.tax_stamp_approval_date = 'Approval date is required';
    if (!formState.taxStampType) allErrors.taxStampType = 'Tax stamp type is required';
    if (!formState.taxStampNumber) allErrors.taxStampNumber = 'Tax stamp number is required';
    
    setFieldErrors(allErrors);
    
    if (Object.keys(allErrors).length === 0) {
      // Convert string values to numbers for API payload
      const payload: CreateNFAPayload = {
        ...formState,
        value: parseFloat(formState.value),
        round_count: parseInt(formState.round_count, 10),
        tax_stamp_approval_date: formState.tax_stamp_approval_date,
        tax_stamp_submission_date: formState.tax_stamp_submission_date,
      };
      
      await addNFAItem(payload, token);
      // Close the drawer on success
      closeDrawer();
    }
  };}

// Screen dimensions for calculating progress bar
const { width: SCREEN_WIDTH } = Dimensions.get('window');

// Constants for calculating progress bar width
const DRAWER_HORIZONTAL_PADDING = 20; // From @team556/ui Drawer component's scrollContent
const HEADER_GRADIENT_HORIZONTAL_PADDING = 20; // From local styles.headerGradient
const PROGRESS_CONTAINER_OWN_HORIZONTAL_PADDING = 1; // From local styles.progressContainer

const TOTAL_HORIZONTAL_PADDING_FOR_PROGRESS_BAR =
  DRAWER_HORIZONTAL_PADDING * 2 + HEADER_GRADIENT_HORIZONTAL_PADDING * 2 + PROGRESS_CONTAINER_OWN_HORIZONTAL_PADDING * 2;

const PROGRESS_BAR_RENDER_WIDTH = SCREEN_WIDTH - TOTAL_HORIZONTAL_PADDING_FOR_PROGRESS_BAR;

// Define the form state type with string values for the form that will be converted to numbers for the API payload
type NFAFormState = Omit<CreateNFAPayload, 'tax_stamp_submission_date' | 'tax_stamp_approval_date' | 'value' | 'round_count'> & {
  tax_stamp_submission_date?: string;
  tax_stamp_approval_date?: string;
  value: string;
  round_count: string;
  images: string[];
};

const initialState: NFAFormState = {
  serialNumber: '',
  manufacturer: '',
  model: '',
  caliber: '',
  nfaType: '',
  additionalInfo: '',
  tax_stamp_submission_date: '',
  tax_stamp_approval_date: '',
  taxStampType: '',
  taxStampNumber: '',
  value: '0',
  round_count: '0',
  images: [],
};

const AddNFADrawerContent = () => {
  const { colors } = useTheme();
  const { addNFAItem, isLoading, error: storeError } = useNFAStore();
  const { token } = useAuthStore();
  const { closeDrawer } = useDrawerStore();

  const [formState, setFormState] = useState<NFAFormState>(initialState);
  const [currentStep, setCurrentStep] = useState(1);
  const [fieldErrors, setFieldErrors] = useState<Partial<Record<keyof NFAFormState, string>>>({});

  const [imagePickerVisible, setImagePickerVisible] = useState(false);
  const [imageUploading, setImageUploading] = useState(false);
  const [imageError, setImageError] = useState<string | null>(null);

  // Step progress animation
  const steps = ['NFA Details', 'Tax Stamp Info', 'Additional Info'];
  const progressAnim = useRef(new Animated.Value(0)).current;

  // Date picker state
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [datePickerField, setDatePickerField] = useState<keyof NFAFormState | null>(null);
  const [currentDateValue, setCurrentDateValue] = useState<Date>(new Date());

  // State for image
  const [selectedImageUri, setSelectedImageUri] = useState<string | null>(null);
  
  // Animate progress bar when step changes
  useEffect(() => {
    Animated.timing(progressAnim, {
      toValue: currentStep - 1,
      duration: 300,
      useNativeDriver: false,
    }).start();
  }, [currentStep, progressAnim]);

  // Handle input changes
  const handleInputChange = (field: keyof NFAFormState, value: string | number | boolean | null) => {
    setFormState((prev) => ({
      ...prev,
      [field]: value,
    }));

    // Clear any error for this field when it's edited
    if (fieldErrors[field]) {
      setFieldErrors((prev) => ({
        ...prev,
        [field]: undefined,
      }));
    }
  };

  // DatePicker modal date functions
  const showMode = (fieldKey: keyof NFAFormState) => {
    const fieldValue = formState[fieldKey] as string;
    const initialPickerDate =
      typeof fieldValue === 'string' && fieldValue && !isNaN(new Date(fieldValue).getTime())
        ? new Date(fieldValue)
        : new Date();

    setCurrentDateValue(initialPickerDate);
    setDatePickerField(fieldKey);
    setShowDatePicker(true);
  };

  const onDateChange = (event: DateTimePickerEvent, selectedDate?: Date) => {
    // Only update the temp state value, don't update form until confirmed
    if (selectedDate) {
      setCurrentDateValue(selectedDate);
    }
  };

  const handleConfirmDate = () => {
    if (datePickerField && currentDateValue) {
      // Update form state with ISO string when confirming
      handleInputChange(datePickerField, currentDateValue.toISOString());
    }
    setShowDatePicker(false); // Close the modal
  };
  
  const handleCancelDate = () => {
    setShowDatePicker(false); // Just close the modal without updating form
  };

  const getDateForPicker = (value: string | Date | undefined): Date | null => {
    if (!value) return null;
    if (value instanceof Date) return value;
    try {
      const date = new Date(value);
      return !isNaN(date.getTime()) ? date : null;
    } catch (e) {
      return null;
    }
  };

    setCurrentDateValue(initialPickerDate);
    setDatePickerField(fieldKey);
    setShowDatePicker(true);
  };

  const validateStep1 = () => {
    const errors: Partial<Record<keyof NFAFormState, string>> = {};
    
    if (!formState.manufacturer) {
      errors.manufacturer = 'Manufacturer is required';
    }
    if (!formState.model_name) {
      errors.model_name = 'Model is required';
    }
    if (!formState.caliber) {
      errors.caliber = 'Caliber is required';
    }
    if (!formState.type) {
      errors.type = 'NFA type is required';
    }
    
    setFieldErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const validateStep2 = () => {
    const errors: Partial<Record<keyof NFAFormState, string>> = {};
    
    if (!formState.tax_stamp_type) {
      errors.tax_stamp_type = 'Tax stamp type is required';
    }
    if (!formState.tax_stamp_submission_date) {
      errors.tax_stamp_submission_date = 'Submission date is required';
    }
    if (!formState.tax_stamp_approval_date) {
      errors.tax_stamp_approval_date = 'Approval date is required';
    }
    // tax_stamp_id_number is optional, so no validation
    
    setFieldErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const validateStep3 = () => {
    const errors: Partial<Record<keyof NFAFormState, string>> = {};
    
    // Value is required
    if (!formState.value || parseFloat(formState.value) < 0) {
      errors.value = 'A valid value is required';
    }
    
    // Round count is required
    if (!formState.round_count || parseInt(formState.round_count) < 0) {
      errors.round_count = 'A valid round count is required';
    }
    
    setFieldErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleNextStep = () => {
    let isValid = false;

    switch (currentStep) {
      case 1:
        isValid = validateStep1();
        break;
      case 2:
        isValid = validateStep2();
        break;
      case 3:
        isValid = validateStep3();
        break;
      default:
        isValid = false;
    }

    if (isValid) {
      if (currentStep < steps.length) {
        setCurrentStep(currentStep + 1);
      }
    }
  };

  const handleSaveNFA = async () => {
    // Final validation for current step
    let isValid = false;
    switch (currentStep) {
      case 1:
        isValid = validateStep1();
        break;
      case 2:
        isValid = validateStep2();
        break;
      case 3:
        isValid = validateStep3();
        break;
      default:
        isValid = false;
    }

    if (!isValid) return;

    // Prepare payload with proper types for API
    const payload: CreateNFAPayload = {
      ...formState,
      tax_stamp_submission_date: formState.tax_stamp_submission_date instanceof Date 
        ? formState.tax_stamp_submission_date.toISOString() 
        : formState.tax_stamp_submission_date,
      tax_stamp_approval_date: formState.tax_stamp_approval_date instanceof Date 
        ? formState.tax_stamp_approval_date.toISOString() 
        : formState.tax_stamp_approval_date,
      value: parseFloat(formState.value),
      round_count: parseInt(formState.round_count)
    };

    const success = await addNFAItem(payload, token);
    if (success) {
      closeDrawer();
    }
  };

  // Image Picker Logic
  const requestMediaLibraryPermissions = async () => {
    try {
      const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert(
          'Permission Required',
          'Please grant access to your photo library to upload images.',
          [
            { text: 'Cancel', style: 'cancel' },
            {
              text: 'Settings',
              onPress: () => Linking.openSettings()
            }
          ]
        );
        return false;
      }
      return true;
    } catch (error) {
      console.error('Error checking permissions:', error);
      return false;
    }
  };

  const pickImageAsync = async () => {
    const hasPermission = await requestMediaLibraryPermissions();
    if (!hasPermission) return;

    let result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [4, 3],
      quality: 0.5, // Lower quality for faster uploads & less storage
      base64: true // Request base64 data
    });

    if (!result.canceled && result.assets && result.assets.length > 0) {
      const asset = result.assets[0];
      setSelectedImageUri(asset.uri);
      
      try {
        // Use ImageManipulator from expo-image-manipulator
        const manipResult = await ImageManipulator.manipulateAsync(
          asset.uri,
          [{ resize: { width: 600 } }],
          { format: ImageManipulator.SaveFormat.JPEG, compress: 0.7, base64: true }
        );

        setFormState({ ...formState, picture_base64: manipResult.base64 });
        setFieldErrors({ ...fieldErrors, picture_base64: undefined });
      } catch (error) {
        console.error('Error processing image:', error);
        setFieldErrors({
          ...fieldErrors,
          picture_base64: 'Error processing image. Please try again.'
        });
      }
    }
  };
  
  // Helper function to determine if a field is the last in its section for styling
  const isLastRowInSection = (field: keyof NFAFormState): boolean => {
    const coreDetailsLastFields = ['type'];
    const taxStampLastFields = ['tax_stamp_id_number'];
    const additionalLastFields = ['picture_base64'];

    return (
      coreDetailsLastFields.includes(field) ||
      taxStampLastFields.includes(field) ||
      additionalLastFields.includes(field)
    );
  };
  
  // Render a form field row with label on left, input on right - exactly matching Firearm form
  const renderDetailRow = (
    label: string,
    field: keyof NFAFormState,
    placeholder: string,
    inputType: 'text' | 'date' | 'select' = 'text',
    // For select type
    items?: Array<{ label: string; value: string | number }>,
    // For text type
    keyboardType: 'default' | 'numeric' | 'email-address' = 'default'
  ) => {
    const fieldValue = formState[field];
    const error = fieldErrors[field];

    let inputComponent: React.ReactNode = null;

    if (inputType === 'date') {
      if (Platform.OS === 'web') {
        // Web-specific date picker would go here if needed
      } else {
        const displayValue = fieldValue
          ? fieldValue instanceof Date
            ? (fieldValue as Date).toLocaleDateString()
            : typeof fieldValue === 'string' && new Date(fieldValue).toString() !== 'Invalid Date'
              ? new Date(fieldValue as string).toLocaleDateString()
              : placeholder // Fallback to placeholder if string is not a valid date
          : placeholder;
          
        inputComponent = (
          <TouchableOpacity onPress={() => showMode(field)} style={styles.dateContainer}>
            <Text style={[styles.dateText, fieldValue ? {} : styles.placeholderText]}>{displayValue}</Text>
            <MaterialCommunityIcons name="calendar" size={20} color="#6C63FF" style={styles.calendarIcon} />
          </TouchableOpacity>
        );
      }
    } else if (inputType === 'select') {
      inputComponent = (
        <View style={styles.selectContainer}>
          <Select
            items={items || []}
            selectedValue={fieldValue as string | number | undefined}
            onValueChange={value => handleInputChange(field, value)}
            placeholder={placeholder}
            style={{
              selectButton: styles.selectButton,
              selectButtonText: fieldValue ? styles.selectButtonText : styles.selectPlaceholderText,
              arrow: {
                color: '#6C63FF',
                fontSize: 14
              },
              modalContent: {
                backgroundColor: '#1B1F2F',
                borderColor: '#6C63FF',
                borderWidth: 1,
                borderRadius: 12,
                paddingVertical: 8
              },
              modalItem: {
                paddingVertical: 12,
                paddingHorizontal: 16,
                borderBottomColor: 'rgba(108, 99, 255, 0.2)'
              },
              modalItemText: {
                fontSize: 15,
                color: '#fff'
              },
              modalOverlay: {
                backgroundColor: 'rgba(0,0,0,0.8)'
              }
            }}
          />
        </View>
      );
    } else {
      // Regular text input
      inputComponent = (
        <TextInput
          style={styles.fieldInput}
          value={fieldValue as string}
          onChangeText={(text: string) => handleInputChange(field, text)}
          placeholder={placeholder}
          placeholderTextColor="rgba(255, 255, 255, 0.5)"
          keyboardType={keyboardType}
        />
      );
    }

    return (
      <View style={styles.fieldRow}>
        <Text style={styles.fieldLabel}>{label}</Text>
        {inputComponent}
        {error && <Text style={styles.errorTextBelow}>{error}</Text>}
      </View>
    );
  };
  
  // Render a form field with label on left, input on right
  const renderDetailRow = (
    label: string,
    field: keyof NFAFormState,
    placeholder: string,
    inputType: 'text' | 'date' | 'select' = 'text',
    items?: Array<{ label: string; value: string | number }>,
    keyboardType: 'default' | 'numeric' | 'email-address' = 'default'
  ) => {
    const fieldValue = formState[field];
    const error = fieldErrors[field];

    let inputComponent: React.ReactNode = null;

    if (inputType === 'date') {
      // Date input display formatting
      const displayValue = fieldValue
        ? fieldValue instanceof Date
          ? (fieldValue as Date).toLocaleDateString()
          : typeof fieldValue === 'string' && new Date(fieldValue).toString() !== 'Invalid Date'
            ? new Date(fieldValue as string).toLocaleDateString()
            : placeholder
        : placeholder;

      inputComponent = (
        <TouchableOpacity onPress={() => showMode(field)} style={styles.dateContainer}>
          <Text style={[styles.dateText, fieldValue ? {} : styles.placeholderText]}>{displayValue}</Text>
          <MaterialCommunityIcons name="calendar" size={20} color="#6C63FF" style={styles.calendarIcon} />
        </TouchableOpacity>
      );
    } else if (inputType === 'select') {
      // Select dropdown
      inputComponent = (
        <View style={styles.selectContainer}>
          <Select
            items={items || []}
            selectedValue={fieldValue as string | number | undefined}
            onValueChange={value => handleInputChange(field, value)}
            placeholder={placeholder}
            style={{
              selectButton: styles.selectButton,
              selectButtonText: fieldValue ? styles.selectButtonText : styles.selectPlaceholderText,
              arrow: {
                color: '#6C63FF',
                fontSize: 14
              },
              modalContent: {
                backgroundColor: '#1B1F2F',
                borderColor: '#6C63FF',
                borderWidth: 1,
                borderRadius: 12,
                paddingVertical: 8
              },
              modalItem: {
                paddingVertical: 12,
                paddingHorizontal: 16,
                borderBottomColor: 'rgba(108, 99, 255, 0.2)'
              },
              modalItemText: {
                fontSize: 15,
                color: '#fff'
              },
              modalOverlay: {
                backgroundColor: 'rgba(0,0,0,0.8)'
              }
            }}
          />
        </View>
      );
    } else {
      // Regular text input
      inputComponent = (
        <TextInput
          style={styles.fieldInput}
          value={fieldValue as string}
          onChangeText={(text: string) => handleInputChange(field, text)}
          placeholder={placeholder}
          placeholderTextColor="rgba(255, 255, 255, 0.5)"
          keyboardType={keyboardType}
        />
      );
    }

    return (
      <View style={styles.fieldRow}>
        <Text style={styles.fieldLabel}>{label}</Text>
        {inputComponent}
        {error && <Text style={styles.errorTextBelow}>{error}</Text>}
      </View>
    );
  };
          />
        </View>
      );
    } else {
      // inputType === 'text'
      inputComponent = (
        <TextInput
          style={styles.inputStyle}
          value={typeof fieldValue === 'number' ? String(fieldValue) : fieldValue as string}
          onChangeText={(text: string) => handleInputChange(field, keyboardType === 'numeric' ? text : text)}
          placeholder={placeholder}
          placeholderTextColor={colors.textTertiary}
          keyboardType={keyboardType}
        />
      );
    }

    return (
      <View style={styles.detailRowContainer}>
        <View style={[styles.detailRow, isLastRowInSection(field) && styles.detailRowLast]}>
          <Text style={styles.detailLabel}>{label}</Text>
          {inputComponent}
        </View>
        {error && <Text style={styles.errorTextBelow}>{error}</Text>}
      </View>
    );
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 1:
        return (
          <View style={styles.sectionWrapper}>
            <View style={styles.sectionHeader}>
              <MaterialCommunityIcons name="information-outline" size={20} color={colors.primary} style={styles.sectionIcon} />
              <Text style={styles.sectionTitle}>NFA Details</Text>
            </View>
            <View style={styles.fieldRow}>
              <Text style={styles.fieldLabel}>Manufacturer</Text>
              <TextInput
                style={styles.fieldInput}
                value={formState.manufacturer}
                onChangeText={(text) => handleInputChange('manufacturer', text)}
                placeholder="Enter manufacturer"
                placeholderTextColor="rgba(255, 255, 255, 0.5)"
              />
            </View>
            
            <View style={styles.fieldRow}>
              <Text style={styles.fieldLabel}>Model</Text>
              <TextInput
                style={styles.fieldInput}
                value={formState.model_name}
                onChangeText={(text) => handleInputChange('model_name', text)}
                placeholder="Enter model name"
                placeholderTextColor="rgba(255, 255, 255, 0.5)"
              />
            </View>
            
            <View style={styles.fieldRow}>
              <Text style={styles.fieldLabel}>Caliber</Text>
              <TextInput
                style={styles.fieldInput}
                value={formState.caliber}
                onChangeText={(text) => handleInputChange('caliber', text)}
                placeholder="Enter caliber"
                placeholderTextColor="rgba(255, 255, 255, 0.5)"
              />
            </View>
            
            <View style={styles.fieldRow}>
              <Text style={styles.fieldLabel}>Type</Text>
              <View style={styles.selectContainer}>
                <Select
                  items={nfaTypeOptions}
                  selectedValue={formState.type}
                  onValueChange={(value) => handleInputChange('type', value)}
                  placeholder="Select NFA Type"
                  style={{
                    selectButton: styles.selectButton,
                    selectButtonText: formState.type ? styles.selectButtonText : styles.selectPlaceholderText,
                    arrow: { color: colors.primary },
                    modalContent: {
                      backgroundColor: '#1E2132',
                      borderColor: colors.primary,
                      borderRadius: 12
                    }
                  }}
                />
              </View>
            </View>
          </View>
        );
      case 2:
        return (
          <View style={styles.sectionWrapper}>
            <View style={styles.sectionHeader}>
              <MaterialCommunityIcons name="file-document-outline" size={20} color={colors.primary} />
              <Text style={styles.sectionTitle}>Tax Stamp Information</Text>
            </View>
            <View style={styles.sectionContent}>
              {renderDetailRow('Tax Stamp Type', 'tax_stamp_type', 'Select Tax Stamp Type', 'select', taxStampTypeOptions)}
              {renderDetailRow('Submission Date', 'tax_stamp_submission_date', 'Select date', 'date')}
              {renderDetailRow('Approval Date', 'tax_stamp_approval_date', 'Select date', 'date')}
              {renderDetailRow('Tax Stamp ID', 'tax_stamp_id_number', 'Enter Tax Stamp ID (optional)', 'text')}
            </View>
          </View>
        );
      case 3:
        return (
          <View style={styles.sectionWrapper}>
            <View style={styles.sectionHeader}>
              <MaterialCommunityIcons name="information-variant" size={20} color={colors.primary} />
              <Text style={styles.sectionTitle}>Additional Information</Text>
            </View>
            <View style={styles.sectionContent}>
              {renderDetailRow('Value', 'value', 'Enter value', 'text', undefined, 'numeric')}
              {renderDetailRow('Round Count', 'round_count', 'Enter round count', 'text', undefined, 'numeric')}
              <View style={styles.detailRowContainer}>
                <View style={styles.detailRow}>
                  <Text style={styles.detailLabel}>NFA Image</Text>
                  <View style={styles.rightContent}>
                    <Button 
                      title='Select Image' 
                      onPress={pickImageAsync} 
                      variant='outline' 
                      style={{ marginBottom: 0 }}
                    />
                  </View>
                </View>
                {selectedImageUri && (
                  <View style={{ alignItems: 'center', marginTop: 10 }}>
                    <Image source={{ uri: selectedImageUri }} style={styles.imagePreview} />
                  </View>
                )}
                {fieldErrors.picture_base64 && <Text style={styles.errorTextBelow}>{fieldErrors.picture_base64}</Text>}
              </View>
            </View>
          </View>
        );
      default:
        return null;
    }
  };

  return (
    <React.Fragment>
      <ScrollView style={styles.container} keyboardShouldPersistTaps='handled'>
        <View style={styles.headerContainer}>
          <View style={styles.header}>
            <View style={styles.headerIconContainer}>
              <MaterialCommunityIcons
                name="shield"
                size={48}
                color={colors.primary}
              />
            </View>
            <Text style={styles.title}>Add New NFA Item</Text>
            <Text style={styles.subtitle}>Enter the details below to add a new NFA item to your collection</Text>
          </View>
        </View>

        <View style={styles.progressContainer}>
          <Animated.View style={[styles.progressBar, { width: animatedProgressWidth }]} />
        </View>

        {renderStepContent()}

        {storeError && (
          <View style={styles.errorContainer}>
            <MaterialCommunityIcons name='alert-circle' size={20} color={colors.error} />
            <Text style={styles.errorText}>Error: {storeError}</Text>
          </View>
        )}

        <View style={styles.stepButtonContainer}>
          {currentStep > 1 ? (
            <Button
              title='Previous'
              onPress={() => setCurrentStep(currentStep - 1)}
              variant='outline'
              style={styles.buttonHalfWidth}
            />
          ) : (
            <View style={styles.buttonHalfWidth} />
          )}
          {currentStep < steps.length && (
            <Button title='Next' onPress={handleNextStep} variant='primary' style={styles.buttonHalfWidth} />
          )}
        </View>

        {currentStep === steps.length && (
          <View style={styles.buttonContainer}>
            <Button
              title={isLoading ? 'Adding...' : 'Add NFA Item'}
              onPress={handleSaveNFA}
              disabled={isLoading}
              variant='primary'
            />
            <Button title='Cancel' onPress={closeDrawer} variant='ghost' style={{ marginTop: 12 }} />
          </View>
        )}
      </ScrollView>

      {/* Date Picker Modal */}
      {showDatePicker && (
        <Modal
          transparent={true}
          animationType="fade"
          visible={showDatePicker}
          onRequestClose={() => {
            setShowDatePicker(false);
            setDatePickerField(null);
          }}
        >
          <TouchableOpacity
            style={styles.modalContainer}
            activeOpacity={1}
            onPress={() => {
              setShowDatePicker(false);
              setDatePickerField(null);
            }}
          >
            <TouchableOpacity activeOpacity={1} onPress={e => e.stopPropagation()}>
              <View style={styles.datePickerContainer}>
                <Text style={styles.datePickerTitle}>Select Date</Text>
                <View style={styles.datePickerContent}>
                  <DateTimePicker
                    testID='dateTimePicker'
                    value={currentDateValue}
                    mode={'date'}
                    is24Hour={true}
                    display={Platform.OS === 'ios' ? 'spinner' : 'default'}
                    onChange={onDateChange}
                    themeVariant='dark'
                    textColor={colors.text}
                    accentColor={colors.primary}
                  />
                </View>

                <View style={styles.datePickerActions}>
                  <Button
                    title='Cancel'
                    onPress={() => {
                      setShowDatePicker(false);
                      setDatePickerField(null);
                    }}
                    variant='ghost'
                    style={{ marginRight: 8 }}
                  />
                  <Button
                    title='Confirm'
                    onPress={handleConfirmDate}
                    variant='primary'
                  />
                </View>
              </View>
            </TouchableOpacity>
          </TouchableOpacity>
        </Modal>
      )}
    </React.Fragment>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    marginBottom: 26,
    paddingHorizontal: 0,
  },
  headerContainer: {
    marginBottom: 16
  },
  header: {
    alignItems: 'center',
    paddingVertical: 20
  },
  headerIconContainer: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: 'transparent',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 16,
    borderWidth: 2,
    borderColor: 'rgba(108, 99, 255, 0.2)'
  },
  title: {
    fontSize: 26,
    fontWeight: 'bold',
    color: '#fff',
    marginBottom: 8,
    textAlign: 'center'
  },
  subtitle: {
    fontSize: 16,
    color: 'rgba(255, 255, 255, 0.7)',
    textAlign: 'center',
    paddingHorizontal: 20
  },
  progressContainer: {
    height: 4,
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    borderRadius: 2,
    marginBottom: 24,
    marginHorizontal: 0
  },
  progressBar: {
    height: '100%',
    backgroundColor: '#6C63FF',
    borderRadius: 2
  },
  sectionWrapper: {
    backgroundColor: 'transparent',
    marginBottom: 16,
    paddingHorizontal: 0,
  },
  sectionHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 12,
    paddingHorizontal: 16,
    marginBottom: 8,
    borderBottomWidth: 0
  },
  sectionIcon: {
    marginRight: 8,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#fff',
    marginLeft: 4
  },
  // New styles for form fields that match the screenshot
  fieldRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(255, 255, 255, 0.1)',
  },
  fieldLabel: {
    color: '#fff',
    fontSize: 16,
    flex: 1,
  },
  fieldInput: {
    flex: 1.5,
    height: 40,
    borderRadius: 8,
    paddingHorizontal: 12,
    backgroundColor: 'rgba(30, 33, 50, 1)',
    color: '#fff',
  },
  selectContainer: {
    flex: 1.5,
  },
  selectButton: {
    backgroundColor: 'rgba(30, 33, 50, 1)',
    borderWidth: 0,
    borderRadius: 8,
    height: 40,
    paddingHorizontal: 12,
  },
  selectButtonText: {
    color: '#fff',
    fontSize: 15,
  },
  selectPlaceholderText: {
    color: 'rgba(255, 255, 255, 0.5)',
    fontSize: 15,
  },
  dateContainer: {
    flex: 1.5,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    height: 40,
    borderRadius: 8,
    paddingHorizontal: 12,
    backgroundColor: 'rgba(30, 33, 50, 1)',
  },
  dateText: {
    color: '#fff',
    fontSize: 15
  },
  placeholderText: {
    color: 'rgba(255, 255, 255, 0.5)'
  },
  calendarIcon: {
    marginLeft: 'auto'
  },
  errorTextBelow: {
    fontSize: 12,
    color: '#FF6B6B',
    marginTop: 4,
    paddingLeft: 4
  },
  errorText: {
    color: '#FF6B6B',
    fontSize: 14,
    marginLeft: 8
  },
  // Date picker modal styles
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.7)',
  },
  datePickerContainer: {
    backgroundColor: '#1B1F2F',
    borderRadius: 16,
    padding: 16,
    width: '85%',
    maxWidth: 350,
    borderWidth: 1,
    borderColor: '#6C63FF',
  },
  datePickerTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#fff',
    marginBottom: 16,
    textAlign: 'center',
  },
  datePickerContent: {
    marginVertical: 16,
  },
  datePickerActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    marginTop: 8,
  }
  },
  errorContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 107, 107, 0.1)',
    padding: 12,
    borderRadius: 8,
    marginBottom: 16
  },
  stepButtonContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 24,
    marginBottom: 16,
    paddingHorizontal: 16,
  },
  buttonContainer: {
    marginTop: 24,
    marginBottom: 16,
    paddingHorizontal: 16,
  },
  buttonHalfWidth: {
    flex: 1,
    marginHorizontal: 4
  },
  imagePreview: {
    width: 120,
    height: 120,
    borderRadius: 8,
    marginTop: 8
  },
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.8)',
    justifyContent: 'center',
    alignItems: 'center'
  },
  datePickerContainer: {
    backgroundColor: '#1B1F2F',
    borderRadius: 16,
    padding: 16,
    width: '90%',
    maxWidth: 340,
    borderWidth: 1,
    borderColor: 'rgba(108, 99, 255, 0.3)'
  },
  datePickerTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#fff',
    textAlign: 'center',
    marginBottom: 16
  },
  datePickerContent: {
    marginBottom: 16
  },
  datePickerActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end'
  },
  rightContent: {
    flexDirection: 'row',
    alignItems: 'center'
  }
});
